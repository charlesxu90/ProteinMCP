# Generate quick_setup.sh Script

## Role
You are an expert at creating shell scripts for setting up Python-based MCP (Model Context Protocol) servers.

## Input Parameters
- `README.md`: The README file containing installation instructions
- `reports/setup_commands.json`: JSON file containing extracted setup commands (if exists)
- `requirements.txt`: Python dependencies (if exists)

## Task

Generate a comprehensive `quick_setup.sh` script that automates the complete setup process for this MCP server.

### Step 1: Analyze Existing Setup Information

1. **Read the README.md** to understand the installation requirements
2. **Read reports/setup_commands.json** if it exists to get the extracted commands
3. **Check for requirements.txt** and note any special dependencies

### Step 2: Generate quick_setup.sh

Create a shell script at the MCP root directory with the following structure:

```bash
#!/bin/bash
# Quick Setup Script for ${MCP_NAME} MCP
# This script sets up the complete environment for running the MCP server
#
# Usage:
#   ./quick_setup.sh              # Full setup
#   ./quick_setup.sh --env-only   # Only create environment
#   ./quick_setup.sh --deps-only  # Only install dependencies (env must exist)
#
# Generated by ProteinMCP

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo -e "${GREEN}=== ${MCP_NAME} MCP Setup ===${NC}"
echo "Working directory: $SCRIPT_DIR"

# Parse arguments
ENV_ONLY=false
DEPS_ONLY=false
for arg in "$@"; do
    case $arg in
        --env-only)
            ENV_ONLY=true
            shift
            ;;
        --deps-only)
            DEPS_ONLY=true
            shift
            ;;
    esac
done

# =============================================================================
# Step 1: Create Python Environment
# =============================================================================
create_environment() {
    echo -e "\n${YELLOW}[Step 1/3] Creating Python environment...${NC}"

    # Check if environment already exists
    if [ -d "./env" ]; then
        echo -e "${GREEN}Environment already exists at ./env${NC}"
        return 0
    fi

    # Try mamba first, then conda, then venv
    if command -v mamba &> /dev/null; then
        echo "Using mamba to create environment..."
        mamba create -p ./env python=${PYTHON_VERSION} -y
    elif command -v conda &> /dev/null; then
        echo "Using conda to create environment..."
        conda create -p ./env python=${PYTHON_VERSION} -y
    else
        echo -e "${YELLOW}Neither mamba nor conda found. Using venv...${NC}"
        python3 -m venv ./env
    fi

    echo -e "${GREEN}Environment created successfully!${NC}"
}

# =============================================================================
# Step 2: Install Dependencies
# =============================================================================
install_dependencies() {
    echo -e "\n${YELLOW}[Step 2/3] Installing dependencies...${NC}"

    # Verify environment exists
    if [ ! -f "./env/bin/pip" ]; then
        echo -e "${RED}Error: Environment not found. Run with --env-only first.${NC}"
        exit 1
    fi

    # Upgrade pip
    ./env/bin/pip install --upgrade pip

    ${DEPENDENCY_INSTALL_COMMANDS}

    echo -e "${GREEN}Dependencies installed successfully!${NC}"
}

# =============================================================================
# Step 3: Install FastMCP
# =============================================================================
install_fastmcp() {
    echo -e "\n${YELLOW}[Step 3/3] Installing FastMCP...${NC}"

    ./env/bin/pip install --ignore-installed fastmcp

    echo -e "${GREEN}FastMCP installed successfully!${NC}"
}

# =============================================================================
# Step 4: Verify Installation
# =============================================================================
verify_installation() {
    echo -e "\n${YELLOW}Verifying installation...${NC}"

    # Check if server.py exists
    if [ -f "src/server.py" ]; then
        SERVER_FILE="src/server.py"
    elif [ -f "src/${MCP_NAME}.py" ]; then
        SERVER_FILE="src/${MCP_NAME}.py"
    else
        # Find any Python file that looks like a server
        SERVER_FILE=$(find src/ -name "*.py" -type f | head -1)
    fi

    if [ -n "$SERVER_FILE" ]; then
        echo "Server file: $SERVER_FILE"
        echo "Testing import..."
        ./env/bin/python -c "import sys; sys.path.insert(0, '.'); exec(open('$SERVER_FILE').read().split('if __name__')[0])" 2>/dev/null && \
            echo -e "${GREEN}Server imports successfully!${NC}" || \
            echo -e "${YELLOW}Warning: Could not verify server imports${NC}"
    fi
}

# =============================================================================
# Main Execution
# =============================================================================
main() {
    if [ "$DEPS_ONLY" = true ]; then
        install_dependencies
        install_fastmcp
    elif [ "$ENV_ONLY" = true ]; then
        create_environment
    else
        create_environment
        install_dependencies
        install_fastmcp
        verify_installation
    fi

    echo -e "\n${GREEN}=== Setup Complete ===${NC}"
    echo ""
    echo "To activate the environment:"
    echo "  source ./env/bin/activate"
    echo ""
    echo "To run the MCP server:"
    echo "  ./env/bin/python ${SERVER_FILE:-src/server.py}"
    echo ""
    echo "To register with Claude Code:"
    echo "  claude mcp add ${MCP_NAME} -- \$(pwd)/env/bin/python \$(pwd)/${SERVER_FILE:-src/server.py}"
}

main "$@"
```

### Step 3: Customize the Script

Replace the placeholders with actual values:

1. **${MCP_NAME}**: The name of the MCP (e.g., "proteinmpnn", "esm")
2. **${PYTHON_VERSION}**: The required Python version from README (default: 3.10)
3. **${DEPENDENCY_INSTALL_COMMANDS}**: The pip install commands from setup_commands.json or README

For **${DEPENDENCY_INSTALL_COMMANDS}**, include all installation commands such as:
- `./env/bin/pip install torch==X.X.X ...` (if PyTorch is needed)
- `./env/bin/pip install -r requirements.txt` (if requirements.txt exists)
- Any other pip install commands from the README

### Step 4: Handle Special Cases

1. **PyTorch with CUDA**: If the README mentions PyTorch with CUDA support:
   ```bash
   # Install PyTorch with CUDA support
   ./env/bin/pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
   ```

2. **Git submodules**: If the repository uses submodules:
   ```bash
   # Initialize git submodules
   git submodule update --init --recursive
   ```

3. **Model downloads**: If models need to be downloaded:
   ```bash
   # Download models
   ./env/bin/python scripts/download_models.py
   ```

4. **Build steps**: If compilation is required:
   ```bash
   # Build native extensions
   cd repo/src && make && cd ../..
   ```

### Step 5: Write the Script

Write the generated script to `quick_setup.sh` in the MCP root directory.

Make sure to:
1. Make the script executable content-wise (starts with `#!/bin/bash`)
2. Include proper error handling (`set -e`)
3. Include informative output messages
4. Handle both fresh install and re-install scenarios

### Step 6: Create setup_commands.json Report

Also update `reports/setup_commands.json` with the final commands used:

```json
{
  "setup_commands": [
    "command1",
    "command2",
    ...
  ],
  "setup_script": "quick_setup.sh",
  "python_version": "3.10"
}
```

## Expected Output

1. **quick_setup.sh** - A complete, executable setup script in the MCP root directory
2. **reports/setup_commands.json** - Updated with setup_script field

## Success Criteria

- [ ] quick_setup.sh created in MCP root directory
- [ ] Script starts with proper shebang (#!/bin/bash)
- [ ] Script includes set -e for error handling
- [ ] Environment creation supports mamba/conda/venv fallback
- [ ] All dependency installation commands included
- [ ] FastMCP installation included
- [ ] Script is idempotent (safe to run multiple times)
- [ ] Informative output messages included
- [ ] reports/setup_commands.json updated with setup_script field

## Important Notes

- Always use `./env/bin/pip` instead of `pip`
- Always use `./env/bin/python` instead of `python`
- Skip activation commands (mamba activate, conda activate)
- Include any model download or build steps from README
- Make sure paths are relative to the MCP directory
- The script should work on a fresh clone of the repository
